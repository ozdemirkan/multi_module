# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@6.1.0
workflows:
  jib_build:
    jobs:
      build:
        docker:
          # specify the version you desire here
          - image: circleci/openjdk:8-jdk

          # Specify service dependencies here if necessary
          # CircleCI maintains a library of pre-built images
          # documented at https://circleci.com/docs/2.0/circleci-images/
          # - image: circleci/postgres:9.4

        working_directory: ~/repo

        environment:
          # Customize the JVM maximum heap limit
          JVM_OPTS: -Xmx3200m
          TERM: dumb

        steps:
          - checkout
          - setup_remote_docker:
              docker_layer_caching: true

          # Download and cache dependencies
          - restore_cache:
              keys:
                - v1-dependencies-{{ checksum "build.gradle" }}
                # fallback to using the latest cache if no exact match is found
                - v1-dependencies-

          - run: gradle dependencies

          - save_cache:
              paths:
                - ~/.gradle
              key: v1-dependencies-{{ checksum "build.gradle" }}

          # run tests!
          - run: gradle jibDockerBuild
  ecr-login:
    jobs:
      - aws-ecr/login:
  ecr-push:
    jobs:
      - aws-ecr/push-image:
          account-url: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          create-repo: true
          repo: wallet/name-service
          tag: latest